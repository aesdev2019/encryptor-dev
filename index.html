<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Encryptor (DEV)</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
        <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
        <script type="text/javascript" language="javascript" src="dzicrypto-1.0.2.js"></script>
        <script src="FileSaver.js"></script>
      </head>
    <body>
        <div class="container">
            <div class="mt-2">
                <label for="pass">Password</label>
                <input type="password" id="pass" class="form-control" placeholder="" value="" required>
            </div>
            
            <div class="mt-2">
                <label for="mode-selector">Mode</label>
<!--                 
                <div class="" id="mode-selector">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="mode" id="mode-text" value="text">
                        <label class="form-check-label" for="mode-text">Text</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="mode" id="mode-file" value="file" checked>
                        <label class="form-check-label" for="mode-file">File</label>
                    </div>
                </div>
 -->
 <!-- TODO change default -->
                <div class="form-group">
                    <select id="mode-selector" class="custom-select" required>

                      <option value="text" >Text</option>
                      <option value="file" selected>File</option>
                    </select>
                  </div>

            </div>

            <div id="text-form">

                <div class="mt-2">
                    <div class="d-flex justify-content-between">
                        <div>
                            <label for="source">Source</label>
                        </div>
                        <div>
                            <button type="button" class="btn btn-light" onclick="pasteSource()">Paste</button>  
                        </div>
                    </div>
                    <textarea id="source" class="form-control" rows="5"></textarea>
                </div>

                <div class="mt-3">
                    <button id="encrypt-button" class="btn btn-primary" onclick="encrypt()">Encrypt</button>
                    <button id="decrypt-button" class="btn btn-primary" onclick="decrypt()">Decrypt</button>
                </div>

                <div class="mt-2">
                    <div class="d-flex justify-content-between">
                        <div>
                            <label for="result">Result</label>
                        </div>
                        <div>
                            <button type="button" class="btn btn-light" onclick="copyResult()">Copy</button>  
                        </div>
                    </div>
                    <textarea id="result" class="form-control" rows="5" readonly></textarea>
                </div>
           
            </div>

            <div id="file-form">
                <div class="mt-2">
                    <div>
                        <label for="source">Source file</label>
                    </div>
<!--                     
                    <input type="text" id="input-file-name" class="form-control" placeholder="" value="" required readonly>
                    <input id="input-file" type="file"/>
                    <button id="input-file-button" class="btn btn-primary" onclick="$('#input-file').click()">Load file...</button>


                    Choose file...

 -->                    
                    <div class="custom-file">
                        <input type="file" id="input-file" class="custom-file-input" required>
                        <label id="input-file-name" class="custom-file-label" for="input-file"></label>
                    </div>
                </div>


                <div class="mt-3">
                    <button id="encrypt-file-button" class="btn btn-primary" onclick="processFile(true)">Encrypt</button>
                    <button id="decrypt-file-button" class="btn btn-primary" onclick="processFile(false)">Decrypt</button>
                </div>

                <div class="mt-2">
                    <div>
                        <label for="result">Result file</label>
                    </div>
                    <input type="text" id="result-file-name" class="form-control" placeholder="" value="" required>
                    <div class="small">In the &laquo;Downloads&raquo; folder</div>
                    <button id="result-file-button" class="btn btn-primary" onclick="saveFile()">Save file</button>

                </div>
            </div>

<!-- <div class="container">
<div id="alert1" class="alert alert-warning alert-dismissible fade show" role="alert">
  <strong>Holy guacamole!</strong> You should check in on some of those fields below.
  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
    <span aria-hidden="true">&times;</span>
  </button>
</div>
<button id="alert-button" class="btn btn-primary">Alert</button>
</div>
 -->        <script>

            function exec(res) {
                var lastError = DziCryptoApi.getLastError();
                var code = lastError.getCode();
                if (code === 0) {
                    return res;
                } else {
                    var msg = "DziCryptoApi error " + code + " with message: '" + lastError.getMessage() + "'";
                    console.error(msg);
                    lastError.reset();
                    // throw new Error(msg);
                    alert("An error has occurred"); // TODO
                }
            }

            function encrypt() {
                $("#result").html();
                var res = exec(DziCryptoApi.encryptMessage($("#source").val(), $("#pass").val(), 23));
                $("#result").val(res);
            }

            function decrypt() {
                $("#result").html();
                var res = exec(DziCryptoApi.decryptMessage($("#source").val(), $("#pass").val()));
                console.log(res);
                $("#result").val(res);
            }

            function copyResult() {
                navigator.clipboard.writeText($("#result").val());
            }

            function pasteSource() {
                navigator.clipboard.readText().then(msg => $("#source").val(msg));
            }

            var textMode, currentFile;

            $(document).ready(function() {
                $("#input-file").change(function() {
                    if (this.files.length) {
                        loadFile(this.files[0]);   
                    }
                }).hide();


              //  $(".alert").hide();
                $("#alert-button").click(function() {
                    $("#alert1").alert();
                    // $('#alert1').alert('close');
                    // $().alert();
                });

                $("#mode-selector").change(changeMode);
                // $("input[name='mode']").change(selectMode);
                changeMode();
            });

            function changeMode() {
                textMode = $("#mode-selector").val() === "text";
                //textMode = $("input[name='mode']:checked").val() === "text";
                if (textMode) {
                    $("#text-form").show();
                    $("#file-form").hide();
                } else {
                    $("#text-form").hide();
                    $("#file-form").show();
                }
                $("#result-file-button").prop("disabled", true);

                // TODO clear all
            }

            function loadFile(file) {
                var reader = new FileReader();
                reader.onloadend = function(ev) {
                    var data = new Uint8Array(ev.target.result);                    
                    if (data.length != file.size) {
                        window.alert("Помилка читання файлу " + file.name);
                        return;
                    }
                    currentFile = {file: file, data: data};
                    // $("#input-file-name").val(file.name);
                    $("#input-file-name").html(file.name);

                    $("#result-file-name").val("");
                    $("#result-file-button").prop("disabled", true);
                };
                reader.readAsArrayBuffer(file);
            }
            
            function processFile(encryption) {
                if (currentFile && currentFile.data)  {
                    var data64 = utils.toBase64(currentFile.data);
                    currentFile.result = utils.fromBase64(encryption 
                            ? exec(DziCryptoApi.encryptMessage(data64, $("#pass").val(), 23)) 
                            : exec(DziCryptoApi.decryptMessage(data64, $("#pass").val())));
                    if ($("#result-file-name").val() === "") { // ???
                        var name = currentFile.file.name;
                        if (encryption) {
                            name += ".enc";
                        } else {
                            if (name.endsWith(".enc")) {
                                name = name.substring(0, name.length - 4);
                            } else {
                                name = "decrypted-" + name;
                            }                        
                        }
                        $("#result-file-name").val(name);
                    }


/*                    
                    var name = currentFile.file.name;
                    if (encryption) {
                        currentFile.result = exec(DziCryptoApi.encryptMessage(utils.toBase64(currentFile.data), $("#pass").val(), 23));
                        name += ".enc";
                    } else {
                        
                        // if (!currentFile.data64) {
                        //     currentFile.data64 = String.fromCharCode.apply(null, currentFile.data);
                        // }
                        // currentFile.result = exec(DziCryptoApi.decryptMessage(currentFile.data64, $("#pass").val()));
                        // currentFile.result = utils.fromBase64(currentFile.result);
                        
                        currentFile.result = exec(DziCryptoApi.decryptMessage(utils.toBase64(currentFile.data), $("#pass").val()));

                        if (name.endsWith(".enc")) {
                            name = name.substring(0, name.length - 4);
                        } else {
                            name = "decrypted-" + name;
                        }
                    }
                    if ($("#result-file-name").val() === "") {
                        $("#result-file-name").val(name);
                    }
*/                    

                    $("#result-file-button").prop("disabled", false);
                }
            }

            function saveFile() {
                console.log("saveFile", currentFile);
                if (!currentFile || !currentFile.result) {
                    alert("Not defined file name!");
                    return;
                }
                var name = $("#result-file-name").val();
                if (!name) {
                    alert("Not defined file name!");
                    return;
                }
                // var blob = new Blob([currentFile.result], {type: "text/plain;charset=utf-8"});
                // var res = utils.fromBase64(currentFile.result);
                var blob = new Blob([currentFile.result], {type: "application/octet-stream"});                

                // console.log("data(blob)", blob);
                saveAs(blob, $("#result-file-name").val());
            }

            var utils = (function() {
                return {
                    toBase64: function(u8a) { 
                        return btoa(String.fromCharCode.apply(null, u8a)); 
                    },
                    fromBase64: function(str) { 
                        return new Uint8Array(atob(str).split('').map(function (c) { return c.charCodeAt(0); })); 
                    }
                }
            })();

        </script>
    </body>
</html>